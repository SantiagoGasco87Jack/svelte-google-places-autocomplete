<script>
import GooglePlacesAutocomplete from '../src/GooglePlacesAutocomplete.svelte'

const options = {
  fields: ['address_components', 'geometry'],
  types: ['(cities)']
}

let displayText = 'Please enter your Google Places API Key'
let googlePlacesApiKey
let locationInput
let onPlaceChangeCallbacks = []
let testPasses = null

function onApiKeyProvided(event) {
  googlePlacesApiKey = event.target.value
  showText('Please wait')
}

function onPlaceChanged(event) {
  while (onPlaceChangeCallbacks.length) {
    onPlaceChangeCallbacks.pop()(event.detail)
  }
}

async function runTests() {
  locationInput = document.querySelector('input')
  locationInput.focus()
  
  try {
    await waitAMoment();
    await runTest1()
  } catch (e) {
    testPasses = false
    showText(e.message)
    locationInput.blur()
  }
}

async function runTest1() {
  return new Promise(async resolve => {
    await type('new')
    showText('Please click on the first suggestion')
    whenPlaceChanges(() => {
      testPasses = (locationInput.value === 'New York, NY, USA')
      clearText()
      resolve()
    })
  })
}

async function waitAMoment(milliseconds = 100) {
  return new Promise(resolve => setTimeout(resolve, milliseconds))
}

async function type(letters) {
  for (let i = 0; i < letters.length; i++) {
    await typeLetter(letters[i])
  }
}

async function typeLetter(letter) {
  return new Promise(resolve => {
    const simulatedEvent = new Event('input', {
      bubbles: true,
      cancelable: true,
      data: letter,
    })
    locationInput.value += letter
    locationInput.dispatchEvent(simulatedEvent)
    waitAMoment().then(resolve)
  })
}

function showText(text) {
  displayText = text
}

function clearText() {
  displayText = ''
}

function whenPlaceChanges(callback) {
  onPlaceChangeCallbacks.push(callback)
}
</script>

<p>{ displayText }</p>

{#if testPasses !== null}
  <p>Test result: { testPasses ? 'PASS' : 'FAIL' }</p>
{/if}

{#if googlePlacesApiKey}
  <GooglePlacesAutocomplete apiKey={googlePlacesApiKey} {options}
                            on:place_changed={onPlaceChanged}
                            on:ready={runTests} />
{:else}
  <input on:change={onApiKeyProvided} />
{/if}
